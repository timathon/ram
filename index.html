<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Audio Player</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      padding: 0;
      box-sizing: border-box;
    }

    h1 {
      text-align: center;
      margin-bottom: 30px;
    }

    .section {
      margin-bottom: 20px;
    }

    .file-list {
      margin-left: 20px;
      padding: 0;
    }

    .file-list li {
      margin-bottom: 8px;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
    }

    .file-list li:hover {
      background-color: #f0f0f0;
    }

    .controls {
      margin: 20px 0;
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
    }

    .controls button {
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 4px;
      background-color: #f5f5f5;
      transition: background-color 0.2s;
      min-width: 120px;
    }

    .controls button:hover {
      background-color: #e0e0e0;
    }

    label {
      margin-right: 10px;
      display: inline-block;
    }

    .file-box {
      border: 1px solid #ccc;
      padding: 15px;
      margin: 15px 0;
      background: #f9f9f9;
      border-radius: 4px;
    }

    .file-box-title {
      font-weight: bold;
      margin-bottom: 12px;
      display: block;
      font-size: 18px;
    }

    .file-list {
      margin-left: 20px;
      padding: 0;
      max-height: 200px; /* Adjusted to show approximately 5 items (36px per item) */
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      background: white;
      border-radius: 4px;
    }

    .file-list li {
      margin-bottom: 8px;
      padding: 5px;
      border-radius: 4px;
      transition: background-color 0.2s;
      list-style-type: none;
      line-height: 1.4; /* Ensuring consistent line height */
    }

    /* Custom scrollbar styling */
    .file-list::-webkit-scrollbar {
      width: 8px;
    }

    .file-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }

    .file-list::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 4px;
    }

    .file-list::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    select, input[type="number"] {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    .dropdown-container {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      margin-bottom: 15px;
      justify-content: center;
    }

    .dropdown-container > div {
      display: flex;
      flex-direction: column;
      min-width: 150px;
    }

    .loop-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin: 15px 0;
    }

    .loop-container label {
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #audio {
      width: 100%;
      margin-top: 20px;
      border-radius: 4px;
    }

    /* Responsive styles */
    @media (max-width: 768px) {
      body {
        margin: 10px;
        padding: 5px;
      }

      .dropdown-container {
        flex-direction: row;
        flex-wrap: wrap;
        gap: 10px;
      }

      .dropdown-container > div {
        min-width: auto;
        flex: 1;
        min-width: 120px;
      }

      .dropdown-container > div:nth-child(3) {
        flex: 0 0 100%; /* Make section dropdown take full width */
      }

      .controls {
        flex-direction: row;
        gap: 10px;
        flex-wrap: nowrap;
      }

      .controls button {
        width: auto;
        padding: 12px;
        min-width: 80px;
        font-size: 14px;
      }

      .file-box {
        padding: 10px;
      }

      .file-list {
        margin-left: 10px;
        max-height: 180px; /* Slightly smaller on mobile */
      }

      select, input[type="number"] {
        width: 100%;
        padding: 10px;
        font-size: 16px; /* Prevents zoom on iOS */
      }
    }

    @media (max-width: 480px) {
      .file-list li {
        padding: 8px 5px;
      }

      .controls {
        flex-wrap: wrap;
      }

      .controls button {
        padding: 14px;
        font-size: 16px;
        min-width: 100px;
      }

      .file-box-title {
        font-size: 16px;
        text-align: center;
      }
      
      .file-list {
        max-height: 150px; /* Even smaller on very small screens */
      }
      
      .dropdown-container > div {
        flex: 0 0 100%; /* Stack all dropdowns on very small screens */
      }
    }
  </style>
  <h1>Audio Player</h1>
  <div id="sections"></div>
  <div class="controls">
    <button id="playBtn">Play Selected</button>
  </div>
  <audio id="audio" controls style="width:100%; margin-top:20px;"></audio>
  <!-- The UI will be dynamically generated by JavaScript based on the textbook -> unit -> section -> files structure from index.json -->
  <script>
    // Load index.json data dynamically
    let indexData = {};
    fetch('wav/index.json')
      .then(response => response.json())
      .then(data => {
      indexData = data;
      buildUI();
      })
      .catch(err => {
      document.getElementById('sections').innerHTML = '<div style="color:red;">Failed to load wav/index.json.</div>';
      });
    // const indexData = {
    //   "A7B": {
    //     "U5": {
    //       "A9-U6-A-1b": {
    //         "files": [
    //           { "name": "A9-U6-A-1b_01.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_01.mp3" },
    //           { "name": "A9-U6-A-1b_02.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_02.mp3" },
    //           { "name": "A9-U6-A-1b_03.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_03.mp3" },
    //           { "name": "A9-U6-A-1b_04.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_04.mp3" },
    //           { "name": "A9-U6-A-1b_05.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_05.mp3" },
    //           { "name": "A9-U6-A-1b_06.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_06.mp3" },
    //           { "name": "A9-U6-A-1b_07.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_07.mp3" },
    //           { "name": "A9-U6-A-1b_08.mp3", "path": "A7B/U5/A9-U6-A-1b/A9-U6-A-1b_08.mp3" }
    //         ]
    //       }
    //     }
    //   },
    //   "A9": {
    //     "U6": {
    //       "A9-U6-A-2d": {
    //         "files": [
    //           { "name": "A9-U6-A-2d_01.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_01.mp3" },
    //           { "name": "A9-U6-A-2d_02.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_02.mp3" },
    //           { "name": "A9-U6-A-2d_03.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_03.mp3" },
    //           { "name": "A9-U6-A-2d_04.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_04.mp3" },
    //           { "name": "A9-U6-A-2d_05.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_05.mp3" },
    //           { "name": "A9-U6-A-2d_06.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_06.mp3" },
    //           { "name": "A9-U6-A-2d_07.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_07.mp3" },
    //           { "name": "A9-U6-A-2d_08.mp3", "path": "A9/U6/A9-U6-A-2d/A9-U6-A-2d_08.mp3" }
    //         ]
    //       }
    //     }
    //   }
    // };
    // Show loop count next to currently playing file
    // Build UI for textbook -> unit -> section -> files structure
    function buildUI() {
      // Populate textbook dropdown
      const sectionsDiv = document.getElementById('sections');
      sectionsDiv.innerHTML = `
        <div class="dropdown-container">
          <div>
            <label for="textbookSelect">Textbook:</label>
            <select id="textbookSelect"></select>
          </div>
          <div>
            <label for="unitSelect">Unit:</label>
            <select id="unitSelect"></select>
          </div>
          <div>
            <label for="sectionSelect">Section:</label>
            <select id="sectionSelect"></select>
          </div>
        </div>
        <div class="loop-container">
          <label for="globalLoopCount">
            Loop count for all selected files:
            <input type="number" min="1" value="1" id="globalLoopCount" style="width:60px;">
          </label>
        </div>
        <div class="file-box">
          <span class="file-box-title">Files: 0 of 0 selected</span>
          <label style="margin-bottom:0 8px;">
            <input type="checkbox" id="selectAllFiles" checked>
            Select All
          </label>
          <ul id="fileListDiv" class="file-list"></ul>
        </div>
      `;

      const textbookSelect = document.getElementById('textbookSelect');
      const unitSelect = document.getElementById('unitSelect');
      const sectionSelect = document.getElementById('sectionSelect');

      // Add event listener for globalLoopCount after element is created
      const globalLoopCountInput = document.getElementById('globalLoopCount');
      if (globalLoopCountInput) {
        globalLoopCountInput.addEventListener('input', function () {
          const newLoopCount = parseInt(this.value) || 1;
          playerState.loopCount = newLoopCount;
          updateLoopCountDisplay();
        });
      }

      // Initial population
      const textbooks = Object.keys(indexData);
      if (textbooks.length === 0) {
        document.getElementById('fileListDiv').innerHTML = '<li>No textbooks found in index.json.</li>';
        return;
      }
      populateDropdown(textbookSelect, textbooks);
      selectedTextbook = textbooks[0];

      textbookSelect.onchange = function () {
        selectedTextbook = this.value;
        updateUnits();
      };
      unitSelect.onchange = function () {
        selectedUnit = this.value;
        updateSections();
      };
      sectionSelect.onchange = function () {
        selectedSection = this.value;
        updateFiles();
      };

      updateUnits();
    }

    // Confirmation dialog when dropdowns change
    function confirmDropdownChange(callback) {
      if (
        playerState.isPlaying ||
        playerState.selectedFiles.length > 0
      ) {
        if (confirm('Changing selection will reset current playback and selected files. Continue?')) {
          callback();
        }
      } else {
        callback();
      }
    }

    // Patch dropdown change handlers after buildUI
    const originalBuildUI = buildUI;
    buildUI = function () {
      originalBuildUI();

      const textbookSelect = document.getElementById('textbookSelect');
      const unitSelect = document.getElementById('unitSelect');
      const sectionSelect = document.getElementById('sectionSelect');

      textbookSelect.onchange = function () {
        confirmDropdownChange(() => {
          selectedTextbook = this.value;
          playerState.isPlaying = false;
          playerState.selectedFiles = [];
          document.getElementById('audio').pause();
          document.getElementById('audio').src = '';
          updateUnits();
        });
      };
      unitSelect.onchange = function () {
        confirmDropdownChange(() => {
          selectedUnit = this.value;
          playerState.isPlaying = false;
          playerState.selectedFiles = [];
          document.getElementById('audio').pause();
          document.getElementById('audio').src = '';
          updateSections();
        });
      };
      sectionSelect.onchange = function () {
        confirmDropdownChange(() => {
          selectedSection = this.value;
          playerState.isPlaying = false;
          playerState.selectedFiles = [];
          document.getElementById('audio').pause();
          document.getElementById('audio').src = '';
          updateFiles();
        });
      };
    };
    function updateLoopCountDisplay() {
      // Remove all existing loop count spans
      document.querySelectorAll('#fileListDiv .loop-count-span').forEach(span => span.remove());
      
      // If playing, add loop count to the currently playing file
      if (
        playerState.isPlaying &&
        playerState.selectedFiles.length > 0 &&
        playerState.fileIdx < playerState.selectedFiles.length
      ) {
        const currentFile = playerState.selectedFiles[playerState.fileIdx].file;
        const currentLi = document.querySelector(`#fileListDiv li[data-file-name="${currentFile}"]`);
        
        if (currentLi) {
          const span = document.createElement('span');
          span.className = 'loop-count-span';
          span.style.marginLeft = '10px';
          span.style.color = '#888';
          span.textContent = `(looping ${playerState.loopIdx} of ${playerState.loopCount})`;
          currentLi.appendChild(span);
        }
      }
    }

    // Call updateLoopCountDisplay whenever playback changes
    function highlightPlayingFile(fileName) {
      document.querySelectorAll('#fileListDiv li').forEach(li => {
        if (li.getAttribute('data-file-name') === fileName) {
          li.style.background = '#ffeeba';
          li.style.fontWeight = 'bold';
          
          // Scroll the file into view if it's not visible
          const fileListDiv = document.getElementById('fileListDiv');
          const fileRect = li.getBoundingClientRect();
          const containerRect = fileListDiv.getBoundingClientRect();
          
          // Check if the element is outside the viewable area
          if (fileRect.top < containerRect.top || fileRect.bottom > containerRect.bottom) {
            // Scroll to the top of the element with some offset for better visibility
            const container = document.getElementById('fileListDiv');
            const scrollTop = li.offsetTop - container.offsetTop;
            container.scrollTop = scrollTop;
          }
        } else {
          li.style.background = '';
          li.style.fontWeight = '';
        }
      });
      updateLoopCountDisplay();
    }






    // Update selected files immediately when checkboxes change
    function updateSelectedFiles() {
      const selectedFiles = [];
      document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
        const file = cb.value;
        selectedFiles.push({
          textbook: document.getElementById('textbookSelect').value,
          unit: document.getElementById('unitSelect').value,
          section: document.getElementById('sectionSelect').value,
          file
        });
      });
      playerState.selectedFiles = selectedFiles;
      updateSelectAllCheckbox();
    }

    // Remove restriction on unchecking last remaining file
    document.addEventListener('change', function (e) {
      if (e.target.classList.contains('file-checkbox')) {
        updateSelectedFiles();
      }
      if (e.target.id === 'selectAllFiles') {
        const checked = e.target.checked;
        document.querySelectorAll('.file-checkbox').forEach(cb => {
          cb.checked = checked;
        });
        updateSelectedFiles();
      }
    });

    // Update "select all" checkbox state
    function updateSelectAllCheckbox() {
      const allCheckboxes = document.querySelectorAll('.file-checkbox');
      const checkedCheckboxes = document.querySelectorAll('.file-checkbox:checked');
      const selectAll = document.getElementById('selectAllFiles');
      
      // Update file counter for all file-box-title elements
      const fileBoxTitles = document.querySelectorAll('.file-box-title');
      fileBoxTitles.forEach(title => {
        title.textContent = `Files: ${checkedCheckboxes.length} of ${allCheckboxes.length} selected`;
      });
      
      if (!selectAll) return;
      if (checkedCheckboxes.length === 0) {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      } else if (checkedCheckboxes.length === allCheckboxes.length) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      }
    }

    let selectedTextbook = '';
    let selectedUnit = '';
    let selectedSection = '';

    // Add Next and Previous buttons to controls
    window.addEventListener('DOMContentLoaded', () => {
      const controlsDiv = document.querySelector('.controls');
      const prevBtn = document.createElement('button');
      prevBtn.id = 'prevBtn';
      prevBtn.textContent = '<<';
      controlsDiv.appendChild(prevBtn);

      const nextBtn = document.createElement('button');
      nextBtn.id = 'nextBtn';
      nextBtn.textContent = '>>';
      controlsDiv.appendChild(nextBtn);
    });

    // Helper to populate dropdowns
    function populateDropdown(select, options) {
      select.innerHTML = '';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    // Update units dropdown
    function updateUnits() {
      const textbookSelect = document.getElementById('textbookSelect');
      const unitSelect = document.getElementById('unitSelect');
      const sectionSelect = document.getElementById('sectionSelect');
      const fileListDiv = document.getElementById('fileListDiv');
      const units = Object.keys(indexData[selectedTextbook] || {});
      populateDropdown(unitSelect, units);
      selectedUnit = units[0] || '';
      updateSections();
    }

    // Update sections dropdown
    function updateSections() {
      const textbookSelect = document.getElementById('textbookSelect');
      const unitSelect = document.getElementById('unitSelect');
      const sectionSelect = document.getElementById('sectionSelect');
      const fileListDiv = document.getElementById('fileListDiv');
      const sections = Object.keys((indexData[selectedTextbook] || {})[selectedUnit] || {});
      populateDropdown(sectionSelect, sections);
      selectedSection = sections[0] || '';
      updateFiles();
    }

    // Update files list
    function updateFiles() {
      const textbookSelect = document.getElementById('textbookSelect');
      const unitSelect = document.getElementById('unitSelect');
      const sectionSelect = document.getElementById('sectionSelect');
      const fileListDiv = document.getElementById('fileListDiv');
      let sectionObj = ((indexData[selectedTextbook] || {})[selectedUnit] || {})[selectedSection];
      let files = (sectionObj && Array.isArray(sectionObj.files)) ? sectionObj.files : [];
      fileListDiv.innerHTML = '';
      if (files.length === 0) {
        fileListDiv.innerHTML = '<li>No files found for this section.</li>';
        updateSelectAllCheckbox();
        return;
      }
      files.forEach((fileObj, idx) => {
        const li = document.createElement('li');
        li.setAttribute('data-file-name', fileObj.name); // For highlight
        li.innerHTML = `
          <label>
            <input type="checkbox" class="file-checkbox" value="${fileObj.name}" checked>
            ${fileObj.name}
          </label>
        `;
        fileListDiv.appendChild(li);
      });
      updateSelectAllCheckbox();
    }

    // Build UI for textbook -> unit -> section -> files structure
    function buildUI() {
      // Populate textbook dropdown
      const sectionsDiv = document.getElementById('sections');
      sectionsDiv.innerHTML = `
        <div class="dropdown-container">
          <div>
            <label for="textbookSelect">Textbook:</label>
            <select id="textbookSelect"></select>
          </div>
          <div>
            <label for="unitSelect">Unit:</label>
            <select id="unitSelect"></select>
          </div>
          <div>
            <label for="sectionSelect">Section:</label>
            <select id="sectionSelect"></select>
          </div>
        </div>
        <div class="loop-container">
          <label for="globalLoopCount">
            Loop count for all selected files:
            <input type="number" min="1" value="1" id="globalLoopCount" style="width:60px;">
          </label>
        </div>
        <div class="file-box">
          <span class="file-box-title">Files: 0 of 0 selected</span>
          <label style="margin-bottom:0 8px;">
            <input type="checkbox" id="selectAllFiles" checked>
            Select All
          </label>
          <ul id="fileListDiv" class="file-list"></ul>
        </div>
      `;

      const textbookSelect = document.getElementById('textbookSelect');
      const unitSelect = document.getElementById('unitSelect');
      const sectionSelect = document.getElementById('sectionSelect');

      // Add event listener for globalLoopCount after element is created
      const globalLoopCountInput = document.getElementById('globalLoopCount');
      if (globalLoopCountInput) {
        globalLoopCountInput.addEventListener('input', function () {
          const newLoopCount = parseInt(this.value) || 1;
          playerState.loopCount = newLoopCount;
          updateLoopCountDisplay();
        });
      }

      // Initial population
      const textbooks = Object.keys(indexData);
      if (textbooks.length === 0) {
        document.getElementById('fileListDiv').innerHTML = '<li>No textbooks found in index.json.</li>';
        return;
      }
      populateDropdown(textbookSelect, textbooks);
      selectedTextbook = textbooks[0];

      textbookSelect.onchange = function () {
        selectedTextbook = this.value;
        updateUnits();
      };
      unitSelect.onchange = function () {
        selectedUnit = this.value;
        updateSections();
      };
      sectionSelect.onchange = function () {
        selectedSection = this.value;
        updateFiles();
      };

      updateUnits();
    }


    // Player state
    let playerState = {
      selectedFiles: [],
      loopCount: 1,
      fileIdx: 0,
      loopIdx: 1,
      isPlaying: false
    };

    // Play selected files with global loop count
    function startPlayback() {
      const selectedFiles = [];
      document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
        const file = cb.value;
        selectedFiles.push({
          textbook: document.getElementById('textbookSelect').value,
          unit: document.getElementById('unitSelect').value,
          section: document.getElementById('sectionSelect').value,
          file
        });
      });

      const loopCount = parseInt(document.getElementById('globalLoopCount').value) || 1;

      if (selectedFiles.length === 0) {
        alert('No files selected.');
        return;
      }
      // Update loop count during playback if globalLoopCount changes
      // Moved to buildUI after element creation
      playerState.selectedFiles = selectedFiles;
      playerState.loopCount = loopCount;
      playerState.fileIdx = 0;
      playerState.loopIdx = 1;
      playerState.isPlaying = true;

      // Preload the second file if it exists
      if (selectedFiles.length > 1) {
        preloadAudio(selectedFiles[1]);
      }

      playCurrent();
    }
    // (Removed duplicate event listener for globalLoopCount; already handled in buildUI)
    // Preload audio file
    function preloadAudio(fileObj) {
      if (!fileObj) return;
      
      const { textbook, unit, section, file } = fileObj;
      const preloadAudio = new Audio();
      preloadAudio.src = `wav/${textbook}/${unit}/${section}/${file}`;
      // Don't play, just load
      preloadAudio.load();
      
      // Optional: Add event listeners for debugging
      preloadAudio.oncanplaythrough = function() {
        console.log(`Preloaded: ${file}`);
      };
      
      preloadAudio.onerror = function() {
        console.log(`Failed to preload: ${file}`);
      };
      
      return preloadAudio;
    }

    function playCurrent() {
      const audio = document.getElementById('audio');
      const files = playerState.selectedFiles;
      const idx = playerState.fileIdx;
      if (idx < 0 || idx >= files.length) {
        playerState.isPlaying = false;
        highlightPlayingFile(null);
        return;
      }
      const { textbook, unit, section, file } = files[idx];
      audio.src = `wav/${textbook}/${unit}/${section}/${file}`;
      audio.play();
      playerState.loopIdx = 1;
      highlightPlayingFile(file);

      // Preload the next file if it exists
      if (idx + 1 < files.length) {
        preloadAudio(files[idx + 1]);
      }

      audio.onended = function () {
        if (!playerState.isPlaying) return;
        if (playerState.loopIdx < playerState.loopCount) {
          playerState.loopIdx++;
          updateLoopCountDisplay();
          audio.currentTime = 0;
          audio.play();
        } else {
          playerState.fileIdx++;
          playCurrent();
        }
      };
    }

    document.getElementById('playBtn').onclick = function () {
      startPlayback();
    };

    // Next and Previous button handlers
    window.addEventListener('DOMContentLoaded', () => {
      const audio = document.getElementById('audio');
      document.getElementById('nextBtn').onclick = function () {
        if (!playerState.selectedFiles.length) return;
        playerState.fileIdx++;
        if (playerState.fileIdx >= playerState.selectedFiles.length) {
          playerState.fileIdx = playerState.selectedFiles.length - 1;
        }
        playerState.loopIdx = 1;
        playCurrent();
      };
      document.getElementById('prevBtn').onclick = function () {
        if (!playerState.selectedFiles.length) return;
        playerState.fileIdx--;
        if (playerState.fileIdx < 0) playerState.fileIdx = 0;
        playerState.loopIdx = 1;
        playCurrent();
      };
    });

    buildUI();
  </script>
</body>

</html>